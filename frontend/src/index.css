:root {
  --bg-1: #0f1724; /* deep navy */
  --bg-2: #071124; /* almost black blue */
  --panel: rgba(255, 255, 255, 0.04);
  --glass: rgba(255, 255, 255, 0.03);
  --muted: #9aa6b2;
  --accent: #6ee7b7; /* teal */
  --accent-2: #7c5cff; /* purple */
  --glass-border: rgba(255, 255, 255, 0.06);
  --glass-blur: 8px;
  --card-radius: 12px;
  --topbar-height: 64px;

  /* keep these in sync with .node-card padding */
  --node-pad-x: 14px;
  --node-pad-y: 12px;
  --handle-size: 12px;
  --handle-border: 2px;

  /* Centralized z-index scale. Dialogs/modals should control stacking
     order and components should use these variables instead of hard-
     coded numbers. Adjust as needed but keep dialog values higher than
     app content. */
  --z-topbar: 1200;
  --z-canvas: 1500;
  --z-templates-overlay: 2000;
  --z-templates-modal: 2001;
  --z-portal: 2002;
  --z-handles: 1600;
}

* { box-sizing: border-box }

html, body, #root { height: 100%; }

body {
  margin: 0;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  background:
    radial-gradient(1200px 600px at 10% 10%, rgba(124, 92, 255, 0.12), transparent),
    radial-gradient(1000px 500px at 90% 90%, rgba(110, 231, 183, 0.06), transparent),
    linear-gradient(180deg, var(--bg-1), var(--bg-2));
  color: #e6eef6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  padding: 0;
}

/* App shell: keep full viewport height */
.app-shell { display: flex; flex-direction: column; min-height: 100vh; }
/* prevent horizontal page growth caused by wide child elements (defensive) */
html, body { max-width: 100%; overflow-x: hidden; }

/* Topbar: fixed to top so it remains visible and doesn't cause page-level scrollbars */
.topbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--topbar-height);
  display: flex; align-items: center; gap: 16px;
  padding: 0 18px; /* horizontal padding only; vertical centering via height */
  border-bottom: 1px solid rgba(255,255,255,0.03);
  backdrop-filter: blur(var(--glass-blur));
  z-index: var(--z-topbar);
}

.brand {
  font-weight: 700; letter-spacing: .6px; margin: 0; display: inline-block; position: relative;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  -webkit-background-clip: text; background-clip: text; color: transparent;
  animation: brand-glow 3s linear infinite;
}
@keyframes brand-glow { 0%{filter:brightness(.95)} 50%{filter:brightness(1.12)} 100%{filter:brightness(.95)} }

.nav { display: flex; gap: 12px; align-items: center }
.nav a { color: var(--muted); text-decoration: none; padding: 6px 10px; border-radius: 8px }
.nav a:hover { color: var(--accent); background: rgba(255,255,255,0.02) }
.nav .cta { color: var(--bg-2); background: linear-gradient(90deg, var(--accent), var(--accent-2)); padding: 6px 10px }

button {
  appearance: none; border: 0; cursor: pointer; padding: 8px 10px; border-radius: 8px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  color: var(--accent); font-weight: 600; transition: transform .12s ease, box-shadow .18s ease;
}
button:hover { filter: brightness(1.08); box-shadow: 0 4px 18px rgba(124,92,255,0.12) }
button:active { transform: translateY(1px) scale(.997) }
button.secondary { background: transparent; color: var(--muted); border: 1px solid rgba(255,255,255,0.02) }

.btn { padding: 8px 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px }
.btn-ghost { background: transparent; color: var(--muted); border: 1px solid rgba(255,255,255,0.03); padding: 6px 10px; border-radius: 8px }
.btn-busy { animation: busy-pulse 1200ms linear infinite; border-radius: 10px }
@keyframes busy-pulse { 0%{box-shadow:0 0 0 0 rgba(110,231,183,0.06)} 50%{box-shadow:0 6px 30px 6px rgba(110,231,183,0.02)} 100%{box-shadow:0 0 0 0 rgba(110,231,183,0)} }

input, textarea, select {
  width: 100%; padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.04);
  background: transparent; color: inherit;
}
textarea { resize: vertical }

.palette-buttons { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap }

/* small variant for compact toolbar buttons used in side panels */
.btn-small { padding: 6px 8px; font-size: 13px; border-radius: 8px }

/* allow palette buttons to shrink to avoid horizontal overflow */
.sidebar .palette-buttons button { min-width: 0 }
.list-scroll {
  max-height: 160px; overflow: auto; border-radius: 8px; padding: 6px;
  border: 1px solid rgba(255,255,255,0.02);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
}

/* -------------------- React Flow: targeted node rules -------------------- */
/* Make the RF node wrapper transparent ONLY for nodes that render .node-card.
   Do NOT change position/display/box-sizing here (RF controls layout). */
.react-flow__node:has(> .node-card) {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}

/* Your visual card: no positioning so handles anchor to wrapper */
.node-card {
  padding: var(--node-pad-y) var(--node-pad-x);
  border-radius: 8px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.192), rgba(255,255,255,0.01));
  border: 1px solid rgba(255,255,255,0.03);
  min-width: 140px;
  max-width: 320px; /* prevent runaway width */
  min-height: 44px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  overflow: hidden; /* keep internal overflow from expanding node wrapper */
  word-wrap: break-word;
  white-space: normal;
  transform-origin: center;
  animation: node-appear 360ms ease both;
}
@keyframes node-appear { from { opacity:0; transform: translateY(6px) scale(.98) } to { opacity:1; transform: translateY(0) scale(1) } }

/* Your existing placement can stay; just tweak the paint */
.react-flow__node:has(> .node-card) .react-flow__handle{
  position: absolute;
  width: var(--handle-size);
  height: var(--handle-size);
  box-sizing: border-box;
  border-radius: 999px;

  /* key changes â†“ */
  background: transparent;                /* let the edge show through */
  border: var(--handle-border) solid rgba(255,255,255,.18);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.25); /* optional definition */
}

/* keep your placement rules (no transforms) */
.react-flow__node:has(> .node-card) .rf-handle-left{
  left:  calc(var(--node-pad-x) - var(--handle-size) / 2);
  top:   calc(50% - var(--handle-size) / 2);
}
.react-flow__node:has(> .node-card) .rf-handle-right{
  right: calc(var(--node-pad-x) - var(--handle-size) / 2);
  top:   calc(50% - var(--handle-size) / 2);
}
.react-flow__node:has(> .node-card) .rf-handle-true{
  right: calc(var(--node-pad-x) - var(--handle-size) / 2);
  top:   calc(28px - var(--handle-size) / 2);
}
.react-flow__node:has(> .node-card) .rf-handle-false{
  right:  calc(var(--node-pad-x) - var(--handle-size) / 2);
  bottom: calc(28px - var(--handle-size) / 2);
}

/* Handle labels (relative to wrapper) */
.react-flow__node:has(> .node-card) .handle-label {
  position: absolute;
  right: calc(var(--node-pad-x) - 18px);
  font-size: 10px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 6px;
  padding: 2px 4px;
  pointer-events: none;
  user-select: none;
  color: var(--muted);
  font-weight: 700;
}
.handle-label-true { top: 28px; }
.handle-label-false { bottom: 28px; }

/* Do NOT include any global ".react-flow__node { position/display/... }" overrides.
   Do NOT include any global ".react-flow__handle { top:50% ... }" overrides. */

/* ------------------------------------------------------------------------ */

.node-card .label { font-weight: 700; color: var(--accent); font-size: 13px }
.node-card:focus { outline: 2px solid rgba(124,92,255,0.12); box-shadow: 0 6px 24px rgba(124,92,255,0.08) }
.node-header { display: flex; align-items: center; gap: 8px }
.node-icon {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px; border-radius: 6px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  color: var(--accent);
}
.node-icon-http { color: var(--accent-2) }
.node-icon-webhook { color: #ffd166 }
.node-icon-llm { color: var(--accent) }
.node-meta { font-size: 12px; color: var(--muted); margin-top: 6px; max-height: 5.2rem; overflow: auto; }

/* -------------------- Layout around the canvas -------------------- */
.topbar-left { display: flex; align-items: center; gap: 12px }
.brand-link { display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit }
.brand-title { font-weight: 700 }
.brand-sub { font-size: 11px; color: var(--muted) }
.spacer { flex: 1 }
.nav-inline { display: flex; gap: 12px; align-items: center }
.page { padding: 20px }
.page-inner { max-width: 900px }
.form-vertical { display: flex; flex-direction: column; gap: 8px; width: 360px }
.form-actions { display: flex; gap: 8px }

/* Ensure the main content sits below the fixed topbar. This prevents double-scrollbar
   issues where children set to 100vh produce extra overflow. */
.main {
  padding-top: var(--topbar-height);
  min-height: calc(100vh - var(--topbar-height));
  overflow: auto;
}

/* Editor layout: avoid 100vh (will overflow when topbar is fixed) */
.editor-root { height: calc(100vh - var(--topbar-height)); width: 100%; overflow: hidden;}
.editor-main { display: flex; height: 100%;  width: 100%; align-items: stretch; min-width: 0; overflow: hidden }
.sidebar {
  width: 320px; max-width: 42%; flex: 0 0 320px; padding: 16px; border-right: 1px solid rgba(255,255,255,0.03);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  overflow: auto; z-index: 3; box-sizing: border-box;
}
.canvas { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; z-index: 2 }
.rightpanel {
  width: 360px; max-width: 42%; flex: 0 0 360px; padding: 16px; border-left: 1px solid rgba(255,255,255,0.03);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  overflow: auto; z-index: 3; box-sizing: border-box;
}

.reactflow-wrapper { height: 100%; background: transparent; position: relative }
.reactflow-wrapper .react-flow { height: 100% }
.reactflow-wrapper .react-flow__viewport { height: 100% }

/* Templates modal (above topbar) */
.templates-overlay {
  position: fixed; inset: 0; background: #000000; z-index: var(--z-templates-overlay); display: flex; align-items: center; justify-content: center;
  /* Ensure the templates overlay establishes its own stacking context and
     sits above other app layers. Use a very high z-index to be robust on
     pages that may create stacking contexts via transforms/isolation. This
     is targeted to the templates overlay only (keeps risk surface small). */
  isolation: isolate;
  z-index: 2147483646 !important;
}
.templates-modal {
  z-index: var(--z-templates-modal); background: #080a0c; border-radius: 12px; padding: 18px; width: min(920px, 95%); max-height: 80vh; overflow: auto; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 12px 60px rgba(0,0,0,0.75);
  /* Force the modal to paint above other stacked content even when an
     ancestor has created a stacking context. This is intentionally
     targeted and uses !important to avoid subtle style precedence issues
     in varied environments. Remove if it causes regressions. */
  isolation: isolate;
  z-index: 2147483647 !important;
}
.template-preview-portal {
  /* Portal container for template previews.
     Attach this to the modal root when possible so it participates in
     the same stacking context. Use the centralized z-index variable
     (no !important) so dialogs control stacking order consistently. */
  position: fixed;
  z-index: var(--z-portal);
  pointer-events: auto;
  transform: none;
}
/* Ensure preview nodes (rendered into the portal) do NOT inject their
   own z-index that could compete with dialog stacking. Keep DOM painting
   order within the modal authoritative. */
.template-preview-portal .react-flow__node,
.template-preview-portal .node-card {
  /* Ensure preview nodes paint above edges/handles within the portal
     without affecting global stacking order. These rules are scoped to
     the portal so dialogs remain authoritative via their z-index vars. */
  z-index: 2 !important;
}

.template-preview-portal .react-flow__handle {
  z-index: 3 !important;
}

.template-preview-portal .react-flow__edge {
  z-index: 1 !important;
}
/* Make TemplatePreview match the visual style of the templates modal so
   previews feel like part of the same surface. Keep this scoped to the
   preview container to avoid affecting other React Flow instances. */
.template-preview {
  background: #080a0c;
  /* Match templates modal surface: radius, border and subtle shadow so
     previews feel like part of the same visual surface. Use slightly
     smaller padding to fit inside cards. */
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.06);
  padding: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.55);
}
.templates-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; margin-top: 8px }
.template-card { padding: 12px; border-radius: 10px; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border: 1px solid rgba(255,255,255,0.02); }
.template-card h4 { margin: 0 0 6px 0 }
.template-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px }

.section-spacing { margin-top: 8px }
.list-item { padding: 6px; border-bottom: 1px solid rgba(255,255,255,0.02) }
.row { display: flex; gap: 12px; align-items: center }
.col { flex: 1 }
.run-meta { color: var(--muted); font-size: 13px }
.mt-6 { margin-top: 6px }
.mt-8 { margin-top: 8px }

.muted { color: var(--muted) }
.runs-list .run-item {
  padding: 8px; border-radius: 8px; margin-bottom: 8px;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  border: 1px solid rgba(255,255,255,0.02);
  animation: run-appear 260ms ease both;
}
@keyframes run-appear { from {opacity:0; transform:translateX(-6px)} to {opacity:1; transform:translateX(0)} }

.log-entry {
  padding: 8px; border-radius: 8px; margin-bottom: 8px;
  background: rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.02);
}
.log-entry pre { white-space: pre-wrap; margin: 0; color: #cfeff3 }

/* Handles should appear above the card content slightly */
.react-flow__handle { z-index: var(--z-handles) }

/* Fix collapsed selects/inputs inside side panels */
/*
  When a flex container's children need to shrink properly the flex item
  must allow widths below their content size. Many browsers default to
  min-width:auto which prevents flex shrink. Setting min-width:0 on the
  form controls inside panels fixes collapsed select/input/textarea cases.
*/
.sidebar input,
.sidebar select,
.sidebar textarea,
.rightpanel select,
.templates-modal select {
  min-width: 0;
  box-sizing: border-box;
}

/* small screens */
@media (max-width:900px) {
  .sidebar { display: none }
  .rightpanel { display: none }
}